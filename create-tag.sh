#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Git —Ç–µ–≥–æ–≤ –≤–µ—Ä—Å–∏–π

echo "üè∑Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ Git —Ç–µ–≥–∞ –¥–ª—è Linux Server Manager"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if [ ! -d ".git" ]; then
    echo "‚ùå –≠—Ç–æ –Ω–µ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ—Ç –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
if [ -n "$(git status --porcelain)" ]; then
    echo "‚ùå –ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏—Ö."
    git status --short
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥
LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)

if [ -n "$LAST_TAG" ]; then
    echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥: $LAST_TAG"
    
    # –ü–∞—Ä—Å–∏–º –≤–µ—Ä—Å–∏—é
    IFS='.' read -ra VERSION_PARTS <<< "${LAST_TAG#v}"
    MAJOR=${VERSION_PARTS[0]}
    MINOR=${VERSION_PARTS[1]}
    PATCH=${VERSION_PARTS[2]}
    
    echo ""
    echo "üéØ –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
    echo "1) Patch (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è) - v$MAJOR.$MINOR.$((PATCH + 1))"
    echo "2) Minor (–Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏) - v$MAJOR.$((MINOR + 1)).0"
    echo "3) Major (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è) - v$((MAJOR + 1)).0.0"
    echo "4) –í–≤–µ—Å—Ç–∏ –≤–µ—Ä—Å–∏—é –≤—Ä—É—á–Ω—É—é"
    echo "5) –û—Ç–º–µ–Ω–∞"
    
    read -p "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç (1-5): " choice
    
    case $choice in
        1)
            NEW_TAG="v$MAJOR.$MINOR.$((PATCH + 1))"
            ;;
        2)
            NEW_TAG="v$MAJOR.$((MINOR + 1)).0"
            ;;
        3)
            NEW_TAG="v$((MAJOR + 1)).0.0"
            ;;
        4)
            read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, v1.2.3): " NEW_TAG
            ;;
        5)
            echo "‚ùå –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ"
            exit 0
            ;;
        *)
            echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
            exit 1
            ;;
    esac
else
    echo "üìã –¢–µ–≥–æ–≤ –µ—â–µ –Ω–µ—Ç"
    echo ""
    echo "üéØ –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é:"
    echo "1) v0.1.0 (–∞–ª—å—Ñ–∞ –≤–µ—Ä—Å–∏—è)"
    echo "2) v1.0.0 (–ø–µ—Ä–≤—ã–π —Ä–µ–ª–∏–∑)"
    echo "3) –í–≤–µ—Å—Ç–∏ –≤–µ—Ä—Å–∏—é –≤—Ä—É—á–Ω—É—é"
    echo "4) –û—Ç–º–µ–Ω–∞"
    
    read -p "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç (1-4): " choice
    
    case $choice in
        1)
            NEW_TAG="v0.1.0"
            ;;
        2)
            NEW_TAG="v1.0.0"
            ;;
        3)
            read -p "–í–≤–µ–¥–∏—Ç–µ –≤–µ—Ä—Å–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, v1.0.0): " NEW_TAG
            ;;
        4)
            echo "‚ùå –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ"
            exit 0
            ;;
        *)
            echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
            exit 1
            ;;
    esac
fi

echo ""
echo "üìù –°–æ–∑–¥–∞–µ–º —Ç–µ–≥: $NEW_TAG"

# –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ç–µ–≥–∞
read -p "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ç–µ–≥–∞ (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–µ—Ä—Å–∏–∏): " TAG_MESSAGE
if [ -z "$TAG_MESSAGE" ]; then
    TAG_MESSAGE="Release $NEW_TAG"
fi

# –°–æ–∑–¥–∞–µ–º —Ç–µ–≥
git tag -a "$NEW_TAG" -m "$TAG_MESSAGE"

if [ $? -eq 0 ]; then
    echo "‚úÖ –¢–µ–≥ $NEW_TAG —Å–æ–∑–¥–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ"
    
    # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –æ push
    read -p "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–≥ –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π? (y/n): " push_choice
    if [[ $push_choice =~ ^[Yy]$ ]]; then
        git push origin "$NEW_TAG"
        if [ $? -eq 0 ]; then
            echo "‚úÖ –¢–µ–≥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–≥–∞"
        fi
    fi
    
    echo ""
    echo "üéâ –¢–µ–≥ $NEW_TAG —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
    echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–≥–µ:"
    echo "   –í–µ—Ä—Å–∏—è: $NEW_TAG"
    echo "   –°–æ–æ–±—â–µ–Ω–∏–µ: $TAG_MESSAGE"
    echo "   –ö–æ–º–º–∏—Ç: $(git rev-parse --short HEAD)"
    echo ""
    echo "üåê –í–µ—Ä—Å–∏—è –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –ø–æ–¥–≤–∞–ª–µ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–≥–∞"
    exit 1
fi
