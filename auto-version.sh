#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –º–∏–Ω–æ—Ä–Ω–æ–π –≤–µ—Ä—Å–∏–∏

echo "üè∑Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
echo "================================"

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")

echo "üìã –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: $CURRENT_VERSION"

# –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–µ—Ä—Å–∏–∏
if [[ $CURRENT_VERSION =~ v([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
    MAJOR=${BASH_REMATCH[1]}
    MINOR=${BASH_REMATCH[2]}
    PATCH=${BASH_REMATCH[3]}
    
    echo "üî¢ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–µ—Ä—Å–∏–∏:"
    echo "   Major: $MAJOR"
    echo "   Minor: $MINOR"
    echo "   Patch: $PATCH"
    
    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∏–Ω–æ—Ä–Ω—É—é –≤–µ—Ä—Å–∏—é
    NEW_MINOR=$((MINOR + 1))
    NEW_VERSION="v${MAJOR}.${NEW_MINOR}.0"
    
    echo ""
    echo "üîÑ –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: $NEW_VERSION"
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç–µ–≥
    echo "üìù –°–æ–∑–¥–∞–µ–º —Ç–µ–≥: $NEW_VERSION"
    if git tag -a "$NEW_VERSION" -m "Auto-increment minor version to $NEW_VERSION"; then
        echo "‚úÖ –¢–µ–≥ $NEW_VERSION —Å–æ–∑–¥–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–≥ –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–≥ –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
        if git push origin "$NEW_VERSION"; then
            echo "‚úÖ –¢–µ–≥ $NEW_VERSION –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"
            echo ""
            echo "üéâ –í–µ—Ä—Å–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!"
            echo "üìã –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: $NEW_VERSION"
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ–≥–∞"
            exit 1
        fi
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ–≥–∞"
        exit 1
    fi
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤–µ—Ä—Å–∏—é: $CURRENT_VERSION"
    exit 1
fi
