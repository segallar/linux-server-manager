#!/bin/bash

echo "üîß –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–∫–µ—Ç–∞–º–∏..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∫—ç—à–∞ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p /tmp
chmod 777 /tmp

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ—á–∏—â–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ apt
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ apt..."
if [ -f "/var/lib/apt/lists/lock" ]; then
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ apt/lists/lock, —É–¥–∞–ª—è–µ–º..."
    rm -f /var/lib/apt/lists/lock
fi

if [ -f "/var/cache/apt/archives/lock" ]; then
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ apt/archives/lock, —É–¥–∞–ª—è–µ–º..."
    rm -f /var/cache/apt/archives/lock
fi

if [ -f "/var/lib/dpkg/lock" ]; then
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ dpkg/lock, —É–¥–∞–ª—è–µ–º..."
    rm -f /var/lib/dpkg/lock
fi

# –û—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
if [ -f "/tmp/package_cache.json" ]; then
    rm -f /tmp/package_cache.json
    echo "‚úÖ –ö—ç—à –ø–∞–∫–µ—Ç–æ–≤ –æ—á–∏—â–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
echo "üîê –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ sudo..."
if ! sudo -n true 2>/dev/null; then
    echo "‚ö†Ô∏è  –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–æ–¥ –ø–∞—Ä–æ–ª—è –¥–ª—è sudo"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥..."
if [ ! -f "/usr/bin/apt" ]; then
    echo "‚ùå –ö–æ–º–∞–Ω–¥–∞ apt –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    exit 1
fi

if [ ! -f "/usr/bin/dpkg" ]; then
    echo "‚ùå –ö–æ–º–∞–Ω–¥–∞ dpkg –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    exit 1
fi

echo "‚úÖ –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –¥–æ—Å—Ç—É–ø–Ω—ã"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º PHP-FPM –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º PHP-FPM..."
if systemctl is-active --quiet php8.3-fpm; then
    systemctl restart php8.3-fpm
    echo "‚úÖ PHP-FPM –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
else
    echo "‚ö†Ô∏è  PHP-FPM –Ω–µ –∑–∞–ø—É—â–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
echo "PHP-FPM: $(systemctl is-active php8.3-fpm)"

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã apt
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã apt..."
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ apt list --upgradable (—Å —Ç–∞–π–º–∞—É—Ç–æ–º 5 —Å–µ–∫):"
timeout 5 apt list --upgradable 2>/dev/null | head -5
if [ $? -eq 124 ]; then
    echo "‚ö†Ô∏è  –ö–æ–º–∞–Ω–¥–∞ apt –∑–∞–≤–∏—Å–ª–∞ (—Ç–∞–π–º–∞—É—Ç)"
else
    echo "‚úÖ –ö–æ–º–∞–Ω–¥–∞ apt —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ"
fi

echo ""
echo "üéâ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!"
echo "üåê –¢–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–∫–µ—Ç–∞–º–∏"
echo "üìù –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞—é—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:"
echo "   - –õ–æ–≥–∏ PHP: /var/log/php8.3-fpm.log"
echo "   - –õ–æ–≥–∏ Nginx: /var/log/nginx/linux-server-manager_error.log"
echo "   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ apt: ls -la /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock"
