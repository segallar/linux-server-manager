#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

echo "‚öôÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
echo "================================================="

WEB_ROOT="/var/www/html/linux-server-manager"
CRON_FILE="/etc/cron.d/linux-server-manager-auto-update"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
if [ ! -d "$WEB_ROOT" ]; then
    echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $WEB_ROOT –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    exit 1
fi

cd "$WEB_ROOT"

echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å cron –∑–∞–¥–∞—á–∏
echo "üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å cron –∑–∞–¥–∞—á–∏:"
if [ -f "$CRON_FILE" ]; then
    echo "‚úÖ Cron —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω: $CRON_FILE"
    echo "üìã –¢–µ–∫—É—â–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ:"
    cat "$CRON_FILE" | grep -v "^#" | grep -v "^$" || echo "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
else
    echo "‚ö†Ô∏è Cron —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –Ω–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É..."

# –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π cron —Ñ–∞–π–ª —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º –≤ 1 –º–∏–Ω—É—Ç—É
cat > "$CRON_FILE" << EOF
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Linux Server Manager
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
* * * * * root /var/www/html/linux-server-manager/auto-update.sh > /dev/null 2>&1

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
0 2 * * * root find /var/www/html/linux-server-manager/logs -name "*.log" -mtime +7 -delete > /dev/null 2>&1
EOF

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
chmod 644 "$CRON_FILE"

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º cron
echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º cron –¥–µ–º–æ–Ω..."
if systemctl reload cron 2>/dev/null; then
    echo "‚úÖ Cron –¥–µ–º–æ–Ω –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω (systemctl)"
elif systemctl reload crond 2>/dev/null; then
    echo "‚úÖ Cron –¥–µ–º–æ–Ω –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω (crond)"
else
    echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å cron –¥–µ–º–æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
    echo "üí° –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é: systemctl reload cron"
fi

echo ""
echo "‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω!"
echo "üìã –ù–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É"
echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å:"
echo "   sudo ./manage-auto-update.sh status"
echo ""
echo "‚è∏Ô∏è –î–ª—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏:"
echo "   sudo ./manage-auto-update.sh pause"
echo ""
echo "üîÑ –î–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
echo "   sudo ./manage-auto-update.sh resume"
