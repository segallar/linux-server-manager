#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º

echo "‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º"
echo "======================================="

WEB_ROOT="/var/www/html/linux-server-manager"
FLAG_FILE="$WEB_ROOT/.pause-auto-update"
LOG_FILE="$WEB_ROOT/logs/auto-update.log"
CRON_FILE="/etc/cron.d/linux-server-manager-auto-update"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)"
    exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞
show_status() {
    echo "üìä –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
    echo "====================================="
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    if [ -f "$FLAG_FILE" ]; then
        echo "‚è∏Ô∏è –°—Ç–∞—Ç—É—Å: –ü–†–ò–û–°–¢–ê–ù–û–í–õ–ï–ù–û"
        echo "üìÖ –§–ª–∞–≥ —Å–æ–∑–¥–∞–Ω: $(stat -c %y "$FLAG_FILE" 2>/dev/null || echo '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')"
    else
        echo "üîÑ –°—Ç–∞—Ç—É—Å: –ê–ö–¢–ò–í–ù–û"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º cron –∑–∞–¥–∞—á—É
    if [ -f "$CRON_FILE" ]; then
        echo "‚è∞ Cron –∑–∞–¥–∞—á–∞: –£–°–¢–ê–ù–û–í–õ–ï–ù–ê"
        echo "üìã –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:"
        cat "$CRON_FILE" | grep -v "^#" | grep -v "^$"
    else
        echo "‚è∞ Cron –∑–∞–¥–∞—á–∞: –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–ê"
    fi
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
    if [ -f "$LOG_FILE" ]; then
        echo ""
        echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥–µ:"
        echo "---------------------------"
        tail -10 "$LOG_FILE" 2>/dev/null || echo "–õ–æ–≥ –ø—É—Å—Ç"
    else
        echo ""
        echo "üìù –õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cron –∑–∞–¥–∞—á–∏
install_cron() {
    echo "‚è∞ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ cron –∑–∞–¥–∞—á–∏..."
    
    # –°–æ–∑–¥–∞–µ–º cron —Ñ–∞–π–ª
    cat > "$CRON_FILE" << EOF
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Linux Server Manager
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
* * * * * root /var/www/html/linux-server-manager/auto-update.sh > /dev/null 2>&1

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
0 2 * * * root find /var/www/html/linux-server-manager/logs -name "*.log" -mtime +7 -delete > /dev/null 2>&1
EOF
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
    chmod 644 "$CRON_FILE"
    
    # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º cron
    systemctl reload cron 2>/dev/null || systemctl reload crond 2>/dev/null
    
    echo "‚úÖ Cron –∑–∞–¥–∞—á–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    echo "üìã –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è cron –∑–∞–¥–∞—á–∏
remove_cron() {
    echo "üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ cron –∑–∞–¥–∞—á–∏..."
    
    if [ -f "$CRON_FILE" ]; then
        rm "$CRON_FILE"
        systemctl reload cron 2>/dev/null || systemctl reload crond 2>/dev/null
        echo "‚úÖ Cron –∑–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞"
    else
        echo "‚ÑπÔ∏è Cron –∑–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
pause_updates() {
    echo "‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è..."
    
    touch "$FLAG_FILE"
    echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    echo "üí° –î–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: $0 resume"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
resume_updates() {
    echo "üîÑ –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è..."
    
    if [ -f "$FLAG_FILE" ]; then
        rm "$FLAG_FILE"
        echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–æ"
    else
        echo "‚ÑπÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —É–∂–µ –∞–∫—Ç–∏–≤–Ω—ã"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
run_update() {
    echo "üöÄ –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è..."
    
    if [ -f "$WEB_ROOT/auto-update.sh" ]; then
        "$WEB_ROOT/auto-update.sh"
    else
        echo "‚ùå –°–∫—Ä–∏–ø—Ç auto-update.sh –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤
clear_logs() {
    echo "üßπ –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤..."
    
    if [ -f "$LOG_FILE" ]; then
        rm "$LOG_FILE"
        echo "‚úÖ –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã"
    else
        echo "‚ÑπÔ∏è –õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
}

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
case "${1:-}" in
    "status")
        show_status
        ;;
    "install")
        install_cron
        ;;
    "remove")
        remove_cron
        ;;
    "pause")
        pause_updates
        ;;
    "resume")
        resume_updates
        ;;
    "run")
        run_update
        ;;
    "clear-logs")
        clear_logs
        ;;
    "help"|"-h"|"--help")
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–∫–æ–º–∞–Ω–¥–∞]"
        echo ""
        echo "–ö–æ–º–∞–Ω–¥—ã:"
        echo "  status      - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
        echo "  install     - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cron –∑–∞–¥–∞—á—É (–∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç)"
        echo "  remove      - –£–¥–∞–ª–∏—Ç—å cron –∑–∞–¥–∞—á—É"
        echo "  pause       - –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
        echo "  resume      - –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
        echo "  run         - –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é"
        echo "  clear-logs  - –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏"
        echo "  help        - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
        echo ""
        echo "–ü—Ä–∏–º–µ—Ä—ã:"
        echo "  sudo $0 install    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
        echo "  sudo $0 pause      # –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
        echo "  sudo $0 status     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å"
        ;;
    *)
        echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $1"
        echo "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: $0 help"
        exit 1
        ;;
esac
